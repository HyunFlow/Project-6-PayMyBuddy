<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Ajouter relation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --blue:#1976d2;
      --blue-active:#1e80ff;
      --text:#1f2937;
      --muted:#6b7280;
      --btn:#f59e0b;
      --btn-hover:#f59e0bcc;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif;
      color:var(--text); background:#fff;
    }
    /* Navigation */
    .nav{
      height:64px; display:flex; align-items:center; justify-content:space-between;
      padding:0 28px; border-bottom:1px solid var(--border); background:#fff;
      position:sticky; top:0; z-index:10;
    }
    .brand{ font-weight:700; }
    .menu{ display:flex; gap:28px; align-items:center; }
    .menu a{ text-decoration:none; color:#111827; font-weight:500; }
    .menu a.active{ color:var(--blue-active); }
    .logout{ color:#111827; opacity:.85; }

    /* Contenu de la page */
    .page{
      max-width:980px; margin:0 auto; padding:60px 20px;
      min-height:calc(100vh - 64px);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    }
    .group{ margin-top:140px; width:100%; max-width:640px; }
    .label{ font-size:18px; font-weight:600; margin-bottom:16px; }
    .row{ display:flex; gap:16px; align-items:center; }
    .row input[type="email"]{
      flex:1; height:44px; padding:0 14px; border-radius:10px;
      border:1px solid var(--border); font-size:16px; outline:none;
    }
    .row input[type="email"]::placeholder{ color:#9ca3af; }
    .row input[type="email"]:focus{ border-color:var(--blue); box-shadow:0 0 0 3px #1e80ff22; }

    .btn{
      height:44px; padding:0 20px; border:none; border-radius:10px; line-height: 44px;
      background:var(--btn); color:#fff; font-size:11px; cursor:pointer;
    }
    .btn:hover{ background:var(--btn-hover); }

    /* Messages */
    .alert{
      margin-top:18px; font-size:11px; padding:10px 12px; border-radius:10px; display:inline-block;
    }
    .alert.success{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .alert.error{ background:#fef2f2; color:#7f1d1d; border:1px solid #fecaca; }

    @media (max-width:640px){
      .row{ flex-direction:column; align-items:stretch; }
      .btn{ width:100%; }
      .group{ margin-top:80px; }
    }

    /* Modale */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; z-index:50;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width:min(520px, 92vw); background:#fff; border-radius:14px; padding:20px;
      box-shadow:0 20px 50px rgba(0,0,0,.18); border:1px solid var(--border);
    }
    .modal h3{ margin:0 0 10px; font-size:18px; }
    .modal p{ margin:0 0 18px; color:#374151; }
    .modal .actions{ display:flex; justify-content:center; gap:10px; }
    .btn-secondary{
      height:44px; padding:0 14px; border-radius:10px; border:1px solid var(--border);
      background:#fff; cursor:pointer;
    }
    .badge{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; margin-bottom:10px;
    }
    .badge.success{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .badge.error{ background:#fef2f2; color:#7f1d1d; border:1px solid #fecaca; }
  </style>
</head>
<body>
<!-- Navigation -->
<header class="nav" role="banner">
  <div class="brand">Pay My Buddy</div>
  <nav class="menu" aria-label="Navigation principale">
    <a th:href="@{/transfer}">Transférer</a>
    <a th:href="@{/profile}">Profil</a>
    <a th:href="@{/relations/new}" class="active" aria-current="page">Ajouter relation</a>
    <a th:href="@{/logout}" class="logout">Se déconnecter</a>
  </nav>
</header>

<!-- Contenu -->
<main class="page" role="main">
  <section class="group" aria-labelledby="relation-title">
    <h1 id="relation-title" class="label">Chercher une relation</h1>

    <!-- Messages flash -->
    <div th:if="${success}" class="alert success" th:text="${success}"></div>
    <div th:if="${error}" class="alert error" th:text="${error}"></div>

    <form th:action="@{/relations}" method="post" th:object="${form}" novalidate>
      <!-- Jeton CSRF (rendu uniquement si activé) -->
      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}" />

      <div class="row">
        <label for="email" class="sr-only" style="position:absolute;left:-10000px;">Adresse e-mail</label>
        <input type="email"
               id="email"
               th:field="*{email}"
               placeholder="Saisir une adresse mail"
               autocomplete="email"
               required />
        <button type="submit" class="btn">Ajouter</button>
      </div>

      <!-- Erreurs de validation du champ -->
      <div th:if="${#fields.hasErrors('email')}" class="alert error" th:errors="*{email}">Email invalide</div>
    </form>
  </section>

  <!-- Modale de succès (rendue si le flash 'success' est présent) -->
  <div class="modal-backdrop" th:if="${success}" id="modalSuccess">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalSuccessTitle">
      <span class="badge success">Succès</span>
      <h3 id="modalSuccessTitle">Relation ajoutée</h3>
      <p th:text="${success}">Relation ajoutée.</p>
      <div class="actions">
        <button type="button" class="btn-secondary" data-close="#modalSuccess">Fermer</button>
        <a th:href="@{/relations/new}" class="btn">OK</a>
      </div>
    </div>
  </div>

  <!-- Modale d’erreur (rendue si le flash 'error' est présent) -->
  <div class="modal-backdrop" th:if="${error}" id="modalError">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalErrorTitle">
      <span class="badge error">Erreur</span>
      <h3 id="modalErrorTitle">Impossible d’ajouter la relation</h3>
      <p th:text="${error}">Une erreur s’est produite.</p>
      <div class="actions">
        <button type="button" class="btn-secondary" data-close="#modalError">Fermer</button>
      </div>
    </div>
  </div>

  <script>
    // Fermer la modale (via le bouton ou l’arrière-plan)
    document.addEventListener('click', function(e){
      const closeSel = e.target.getAttribute && e.target.getAttribute('data-close');
      if (closeSel) {
        const host = document.querySelector(closeSel);
        if (host) host.classList.remove('show');
        return;
      }
      // Fermer en cliquant sur l’arrière-plan (backdrop)
      if (e.target.classList && e.target.classList.contains('modal-backdrop')) {
        e.target.classList.remove('show');
      }
    });

    // Afficher les modales rendues côté serveur au chargement
    window.addEventListener('DOMContentLoaded', () => {
      const s = document.getElementById('modalSuccess');
      const e = document.getElementById('modalError');
      if (s) s.classList.add('show');
      if (e) e.classList.add('show');
    });
  </script>
</main>
</body>
</html>
